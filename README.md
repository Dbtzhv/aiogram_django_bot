# Установка
**1.** git clone https://github.com/Dbtzhv/aiogram_django_bot.git <br>
**2.** переходим в склонированную папку в консоли и выполняем команду: python -m venv venv. Потом активируем виртуальное окружение<br>
**3.** устанавливаем зависимости в виртуальное окружение: pip install -r requirements.txt <br>
**4.** создаём суперюзера: python manage.py createsuperuser <br>
**5.** переходим в bot/bot.py и вставляем токен своего бота в переменную bot = Bot(''). Токен можно получить у @BotFather <br>
**6.** запускаем сервер django, находясь папке aiogram_django_bot: python manage.py runserver <br>
**7.** открываем вторую консоль, переходим в aiogram_django_bot/bot и запускаем бота: python bot.py <br>
**8.** смотрим проект

# Структура проекта <br>
**1. директория bot** - директория с ботом. bot.py - файл бота; services.py - файл с бизнес логикой бота <br>
**2. директория bot_messages** - директория приложения, отвечающего за сохранение ответов бота на weather и news команды <br>
**3. директория commands** - директория приложения, отвечающего за изменение команд бота <br>
**4. директория src** - корневая директория проекта django <br>
**5. файл chart_example.png** - картинка с примером диаграммы <br>
**1. файл db.sqlite3** - БД c сообщениями, созданными в разные месяцы для разнообразия диаграммы (см. раздел эндпоинты) <br>
**1. файл requirements.txt** - зависимости проекта <br>

# По сути, бот работает в связке с админкой Django. Ну и есть 3 сторонних эндпоинта: сваггер, диаграмма и получение листа сообщений пользователем

# Эндпоинты 

**1.** http://localhost:8000/list/commands/ - ДЛЯ БОТА: эндпоинт для получения имён команд и текста сообщений ботом <br>
**2.** http://localhost:8000/api/create_telegram_message/ - ДЛЯ БОТА: эндпоинт для добавления ответа бота в БД <br>
**3.** http://localhost:8000/api/user_messages/ - ДЛЯ ПОЛЬЗОВАТЕЛЯ: эндпоинт для просмотра пользователем своей истории сообщений (если параметр from_user_id не указан, тогда возвращается лист экземпляров класса TelegramMessage всех пользователей) <br>
**4.** http://localhost:8000/api/chart/ - ДЛЯ СУПЕРЮЗЕРА: эндпоинт с диаграммой, показывающей, сколько экземпляров класса TelegramMessage было создано в каждом месяце года. Эндпоинт доступен только для суперюзера (сначала нужно выполнить команду python manage.py createsuperuser, создающую суперюзера, а затем выполнить логин по адресу: http://localhost:8000/admin/. После этого эндпоинт станет доступен). Важно сказать, что у модели TelegramMessage created_at автоматически заполняется: created_at = models.DateTimeField(auto_now_add=True). Поэтому создать экземпляры с разными created_at, чтобы просмотреть диаграму с разными столбами, вряд ли получится. Для этого я загрузил в гитхаб готовую БД с разными значениями, к которым можно будет добавить самостоятельно несколько сообщений с нынешнего месяца. Либо можно посмотреть на фотку-пример, которую я оставил среди файлов, ну или, если хочется всё сделать с нуля - убрать auto_now_add, сделать миграции (1.python manage.py makemigrations -> 2.python manage.py migrate) и создавать TelegramMessage'и через админку с указанием нужной даты создания.  <br>
**5.** http://localhost:8000/api/schema/swagger-ui/ - ДЛЯ ПОЛЬЗОВАТЕЛЯ: сваггер

# Работа бота

Бот поддерживает следующие команды: <br>
**1. /start** - просто возвращает текст <br>
**2. /help** -  просто возвращает текст <br>
**3. /weather** [название города] - возвращает температуру в указанном городе . Этот ответ сохраняется в БД  (Message id, From user id, Chat id, Text, Created at) <br>
**4. /news** - возвращает рандомную новость. Этот ответ сохраняется в БД Сохраняется в БД  (Message id, From user id, Chat id, Text, Created at) <br>

**Команды:** <br> Название команд можно поменять в админке в разделе Commands. Там же можно поменять текст сообщений команд /start и /help (у /weather и /news текст сообщения не фиксированный и берётся со стороннего API, поэтому там нет смысла менять или добавлять текст). Бот поддерживает только эти 4 команды, добавление новых экземпляров класса Command ничего не даст! <br>
Например: у нас есть команда /start с текстом "Привет"; можно зайти в админку, поменять либо title команды, к примеру, на go, либо text "Привет", на какой-то "Добрый день", либо всё вместе. Тогда /start с ответом "Привет" превратится в /go с ответом "Добрый день" <br>

**Сообщения:** <br> Историю сообщений можно посмотреть в админке в разделе Telegram messages (можно посмотреть для каждого пользователя/чата или все вместе. Для того, чтобы отфильтровать справа есть окошко filter). Сообщения отсортированы по дате, сверху самые свежие.

